<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- [Le même CSS que précédemment] -->
         <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .filiere-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filiere-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .filiere-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .filiere-card.active {
            border: 2px solid #4CAF50;
        }

        .students-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .student-info p {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .edit-button {
            background-color: #2196F3;
            color: white;
            width: 100%;
        }

        .save-button {
            background-color: #4CAF50;
            color: white;
        }

        .cancel-button {
            background-color: #f44336;
            color: white;
        }

        button:hover {
            opacity: 0.9;
        }

        .title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .selected-filiere {
            font-size: 20px;
            margin: 20px 0;
            color: #4CAF50;
        }
    </style>   
</head>
<body>
    <h1 class="title">Gestion des Étudiants par Filière</h1>
    <div class="filiere-container" id="filiereContainer"></div>
    <div id="selectedFiliere" class="selected-filiere"></div>
    <div class="students-container" id="studentsContainer"></div>

    <script>
        let currentStudents = [];
        let allFilieres = [];
        
        // Fonction pour formater la date au format Oracle (DD-MM-YYYY)
        function formatDateForOracle(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Fonction pour formater la date pour l'input HTML (YYYY-MM-DD)
        function formatDateForHTML(dateString) {
            if (!dateString) return '';
            const [day, month, year] = dateString.split('-');
            return `${year}-${month}-${day}`;
        }

        async function loadFilieres() {
            try {
                const response = await fetch('/filiereget');
                allFilieres = await response.json();
                displayFilieres(allFilieres);
            } catch (error) {
                console.error('Erreur lors du chargement des filières:', error);
            }
        }

        function displayFilieres(filieres) {
            const container = document.getElementById('filiereContainer');
            container.innerHTML = '';
            
            filieres.forEach(filiere => {
                const card = document.createElement('div');
                card.className = 'filiere-card';
                card.onclick = () => loadStudents(filiere.filiere);
                card.innerHTML = `
                    <h3>${filiere.filiere}</h3>
                `;
                container.appendChild(card);
            });
        }

        async function loadStudents(filiere) {
            try {
                document.querySelectorAll('.filiere-card').forEach(card => {
                    card.classList.toggle('active', card.textContent.trim() === filiere);
                });

                document.getElementById('selectedFiliere').textContent = `Étudiants de la filière : ${filiere}`;

                const response = await fetch('/api/students');
                const students = await response.json();
                currentStudents = students.filter(student => student.filiere === filiere);
                displayStudents();
            } catch (error) {
                console.error('Erreur lors du chargement des étudiants:', error);
            }
        }

        function displayStudents() {
            const container = document.getElementById('studentsContainer');
            container.innerHTML = '';
            
            currentStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="student-info">
                        <p><strong>Filière:</strong> ${student.filiere}</p>
                        <p><strong>Nom:</strong> ${student.username}</p>
                        <p><strong>Email:</strong> ${student.email}</p>
                        <p><strong>Téléphone:</strong> ${student.telephone}</p>
                        <p><strong>Date de naissance:</strong> ${student.dateNaissance}</p>
                        <p><strong>Âge:</strong> ${student.age}</p>
                        <p><strong>Année:</strong> ${student.annee}</p>
                        <button onclick="editStudent(${student.id})" class="edit-button">Modifier</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function editStudent(studentId) {
            const student = currentStudents.find(s => s.id === studentId);
            const card = document.querySelector(`[onclick="editStudent(${studentId})"]`).parentNode.parentNode;
            
            const filiereOptions = allFilieres
                .map(f => `<option value="${f.filiere}" ${f.filiere === student.filiere ? 'selected' : ''}>${f.filiere}</option>`)
                .join('');

            // Convertir la date au format HTML
            const htmlDate = formatDateForHTML(student.dateNaissance);

            card.innerHTML = `
                <form class="edit-form" onsubmit="saveStudent(event, ${studentId})">
                    <div class="form-group">
                        <label>Filière</label>
                        <select name="filiere">
                            ${filiereOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" name="username" value="${student.username}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" value="${student.email}">
                    </div>
                    <div class="form-group">
                        <label>Téléphone</label>
                        <input type="tel" name="telephone" value="${student.telephone}">
                    </div>
                    <div class="form-group">
                        <label>Date de naissance</label>
                        <input type="date" name="dateNaissance" value="${htmlDate}">
                    </div>
                    <div class="form-group">
                        <label>Âge</label>
                        <input type="number" name="age" value="${student.age}">
                    </div>
                    <div class="form-group">
                        <label>Année</label>
                        <input type="number" name="annee" value="${student.annee}">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="save-button">Enregistrer</button>
                        <button type="button" onclick="displayStudents()" class="cancel-button">Annuler</button>
                    </div>
                </form>
            `;
        }

        async function saveStudent(event, studentId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const currentStudent = currentStudents.find(s => s.id === studentId);
            
            // Créer l'objet avec uniquement les champs modifiés
            const updatedFields = {};
            for (let [key, value] of formData.entries()) {
                if (value !== '') {
                    if (key === 'dateNaissance') {
                        const formattedDate = formatDateForOracle(value);
                        if (formattedDate !== currentStudent[key]) {
                            updatedFields[key] = formattedDate;
                        }
                    } else if (value !== currentStudent[key]) {
                        updatedFields[key] = value;
                    }
                }
            }

            // Fusionner avec les données existantes
            const updatedStudent = {
                ...currentStudent,
                ...updatedFields
            };

            try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedStudent)
                });

                if (response.ok) {
                    if (updatedFields.filiere && updatedFields.filiere !== currentStudent.filiere) {
                        await loadStudents(currentStudent.filiere);
                    } else {
                        currentStudents = currentStudents.map(student => 
                            student.id === studentId ? updatedStudent : student
                        );
                        displayStudents();
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour:', error);
            }
        }

        window.onload = loadFilieres;
    </script>
</body>
</html>